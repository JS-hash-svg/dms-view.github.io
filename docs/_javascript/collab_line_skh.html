<!DOCTYPE html>
<meta charset="utf-8">
<style>

.point {
  fill: #2f225d;
  stroke: #afa2dc;
}

.line {
  fill: none;
  stroke: grey;
  stroke-width: 1px;
}

.brushed {
  fill: #afa2dc;
  stroke: #2f225d;
}

.clicked {
  fill: #afa2dc;
  stroke: #2f225d;
}

.axis {
  font: 10px sans-serif;
}

p {
  font: 12px sans-serif;
  margin: 0 0 2px 0;
  padding: 0;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.brush .extent {
  stroke: #fff;
  fill-opacity: .125;
  shape-rendering: crispEdges;
}

</style>
<body>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script>

// generate some fake data
var data = [];
var values = [];
for (var i = 2; i <= 50; i++) {
    var val = Math.floor(Math.random() * (50 - 5 + 1) + 5);
    data.push({index: i, value: val});
    values.push(val);
}

// set up the plot
var margin = {top: 20, right: 20, bottom: 60, left: 40},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var x = xScale = d3.scaleLinear().range([0, width]).domain([0, 50]),
yScale = d3.scaleLinear().range([0, height]).domain([0, d3.max(values) + 5]),
xAxis = d3.axisBottom(xScale),
yAxis = d3.axisLeft(yScale),
valueline = d3.line().x(XFocus).y(YFocus),
brush = d3.brush().extent([[0,0], [width, height]]).on("brush end", brushSelection);


// make the svg
var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
   .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// add in the axes
svg.append("g")
    .attr("class", "axis axis--x")
    .attr("id", "axis_x")
    .attr("clip-path", "url(#clip)")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis);

svg.append("g")
    .attr("class", "axis axis--y")
    .attr("id", "axis_y")
    .call(yAxis);

svg.append("g")
    .attr("class", "brush")
    .call(brush)
  .selectAll('rect')
    .attr('height', height);

// add in the line
svg.append("path")
  .datum(data)
  .attr("class", "line")
  .style("clip-path", "url(#clip)")
  .attr("d", valueline);

// Plot a circle for each site in the given data.
var circlePoint = svg.append("g")
  .selectAll("circle")
  .data(data)
  .enter()
  .append("circle");

  var circleAttributes = circlePoint
    .attr("r", 5)
    .attr("cx", XFocus)
    .attr("cy", YFocus)
    .attr("id", d => "site_" + d.index)
    .attr("class", "non_brushed")
    // .style("clip-path", "url(#clip)")
    .on("click", selectPoint);

// selection function
  function selectPoint(d) {
    console.log("Select site: " + d.index );
    if (d3.select(this).classed("brushed") && d3.select(this).classed("clicked")){
      d3.select(this).classed("brushed", false);
      d3.select(this).classed("clicked", false);
    }
    else if (d3.select(this).classed("clicked")){
      d3.select(this).classed("clicked", false)
    }
    else if (d3.select(this).classed("brushed")){
      d3.select(this).classed("brushed", false)
    }
    else{
      d3.select(this).classed("clicked", true)
    }
  }

  function brushSelection(){
    extent = d3.event.selection
    circlePoint.classed("brushed", function(d){return isBrushed(extent, d)})
  }


  function isBrushed(brush_coords, d) {
    cx = xScale(d.index);
    cy = yScale(d.value);
       var x0 = brush_coords[0][0],
           x1 = brush_coords[1][0],
           y0 = brush_coords[0][1],
           y1 = brush_coords[1][1];
      return x0 <= cx && cx <= x1 && y0 <= cy && cy <= y1;    // This return TRUE or FALSE depending on if the points is in the selected area
  }


function XFocus(d) {
  return xScale(+d.index);
}

function YFocus(d) {
  return yScale(+d.value);
}

</script>
